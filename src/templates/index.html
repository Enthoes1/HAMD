<!DOCTYPE html>
<html>
<head>
    <title>HAMD评估系统</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            background-color: #f5f5f5;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background-color: #007bff;
            color: white;
            padding: 1rem;
            text-align: center;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            flex-grow: 1;
        }

        .header-button {
            background-color: white;
            color: #007bff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            margin-left: 1rem;
        }

        .header-button:hover {
            background-color: #f8f9fa;
        }

        .container {
            flex: 1;
            padding: 1rem;
            margin-top: 60px;
            margin-bottom: 150px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 20px;
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.8rem;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .system {
            background-color: #e9ecef;
            margin-left: 0;
        }

        .assistant {
            background-color: #e9ecef;
            margin-left: 0;
        }

        .user {
            background-color: #007bff;
            color: white;
            margin-left: auto;
        }

        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 1rem;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
        }

        #user-input {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px;
            outline: none;
        }

        #record-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }

        #record-button:hover {
            transform: scale(1.05);
        }

        #record-button.recording {
            background-color: #dc3545;
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        #send-button {
            padding: 0.8rem 1.5rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
        }

        #send-button:disabled {
            background-color: #ccc;
        }

        .patient-info {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .patient-info .form-group {
            margin-bottom: 1rem;
        }

        .patient-info label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .patient-info input,
        .patient-info select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            background-color: white;
        }

        .patient-info button {
            width: 100%;
            padding: 0.8rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 1rem;
        }

        .patient-info button:hover {
            background-color: #0056b3;
        }

        @media (max-width: 768px) {
            .message {
                max-width: 90%;
            }

            .input-container {
                padding: 0.8rem;
            }

            #user-input {
                font-size: 16px;
                padding: 0.6rem;
            }

            #send-button {
                padding: 0.6rem 1.2rem;
            }
        }

        /* 防止iOS设备上的输入框放大 */
        @media screen and (-webkit-min-device-pixel-ratio: 0) { 
            select,
            textarea,
            input {
                font-size: 16px !important;
            }
        }

        /* 添加输入时的动画效果 */
        .typing {
            background-color: #e9ecef;
            padding: 0.8rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: none;
        }

        .typing span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #666;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1s infinite;
        }

        .typing span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .status {
            display: none;  /* 隐藏状态显示 */
            text-align: center;
            padding: 0.5rem;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        /* 播放按钮样式 */
        .play-button {
            display: inline-block;
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
        }

        /* 开关按钮样式 */
        .voice-mode-toggle {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 1rem;
            padding: 0.5rem;
        }
        
        .voice-mode-toggle span {
            margin-right: 0.5rem;
            font-size: 14px;
            color: #555;
        }
        
        /* 开关样式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }
        
        input:checked + .slider {
            background-color: #2196F3;
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .slider.round {
            border-radius: 24px;
        }
        
        .slider.round:before {
            border-radius: 50%;
        }

        /* AI头像和麦克风固定区域 */
        .ai-controls-fixed {
            position: fixed;
            bottom: 70px;
            left: 0;
            right: 0;
            background-color: rgba(245, 245, 245, 0.9);
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 90;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            border-top: 1px solid #e0e0e0;
        }

        .ai-avatar-container {
            text-align: center;
            margin: 5px auto;
            position: relative;
        }

        .ai-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #007bff;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .ai-avatar i {
            font-size: 40px;
            color: white;
        }

        .ai-avatar .status-text {
            position: absolute;
            bottom: -25px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 14px;
            color: #333;
            font-weight: bold;
        }

        .ai-status-listening .ai-avatar {
            background-color: #28a745;
            animation: pulse-green 1.5s infinite;
        }

        .ai-status-speaking .ai-avatar {
            background-color: #007bff;
            animation: pulse-blue 1.5s infinite;
        }

        .ai-status-thinking .ai-avatar {
            background-color: #ffc107;
            animation: pulse-yellow 1.5s infinite;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(0, 123, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
        }

        @keyframes pulse-yellow {
            0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 193, 7, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
        }

        .mic-container {
            text-align: center;
            margin: 30px auto 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>HAMD评估系统</h1>
        <nav class="nav-links">
            <a href="/" class="header-button active">HAMD评估</a>
            <a href="/phq9" class="header-button">PHQ-9自评</a>
            <a href="/admin" class="header-button">管理系统</a>
        </nav>
    </div>

    <div class="container">
        <div class="voice-mode-toggle">
            <span>语音模式：</span>
            <label class="switch">
                <input type="checkbox" id="voice-mode-toggle" checked>
                <span class="slider round"></span>
            </label>
        </div>
        
        <div class="chat-container">
            <div id="chat-messages"></div>
            <div class="typing">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>
    
    <!-- 固定的AI头像和麦克风按钮区域 -->
    <div class="ai-controls-fixed">
        <!-- AI头像 -->
        <div class="ai-avatar-container">
            <div class="ai-avatar">
                <i class="fas fa-robot"></i>
                <div class="status-text">等待中</div>
            </div>
        </div>
        
        <!-- 麦克风按钮容器 -->
        <div class="mic-container">
            <button id="record-button" onclick="toggleRecording()">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
    </div>

    <div class="input-container">
        <input type="text" id="user-input" placeholder="请输入您的回答...">
        <button id="send-button" onclick="sendMessage()">发送</button>
    </div>

    <script>
        const socket = io();
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.querySelector('.typing');
        const voiceModeToggle = document.getElementById('voice-mode-toggle');
        const aiAvatar = document.querySelector('.ai-avatar-container');
        const aiStatusText = document.querySelector('.ai-avatar .status-text');
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let mediaStream = null;
        let currentAudio = null;
        let silenceDetector = null;
        let silenceTimer = null;
        let silenceThreshold = -25; // 调整为更合理的静音阈值
        let silenceTimeout = 1500;  // 静音超时时间
        let autoRecordEnabled = true; // 是否启用自动录音
        let consecutiveSilenceCount = 0; // 连续检测到静音的次数
        let requiredSilenceCount = 1; // 需要连续检测到的静音次数
        let userHasSpoken = false; // 新增：标记用户是否已经开始说话
        let consecutiveSpeakingCount = 0; // 新增：连续检测到说话的次数
        let requiredSpeakingCount = 3; // 新增：需要连续检测到说话的次数才认为用户开始说话
        let preinitializedStream = null; // 预先初始化的麦克风流
        
        // AI状态更新函数
        function updateAIStatus(status) {
            // 移除所有状态类
            aiAvatar.classList.remove('ai-status-listening', 'ai-status-speaking', 'ai-status-thinking');
            
            // 添加新状态类
            if (status) {
                aiAvatar.classList.add(`ai-status-${status}`);
                
                // 更新状态文本
                switch(status) {
                    case 'listening':
                        aiStatusText.textContent = '聆听中...';
                        break;
                    case 'speaking':
                        aiStatusText.textContent = '说话中...';
                        break;
                    case 'thinking':
                        aiStatusText.textContent = '思考中...';
                        break;
                    default:
                        aiStatusText.textContent = '等待中';
                }
            } else {
                aiStatusText.textContent = '等待中';
            }
        }
        
        // 从本地存储恢复语音模式设置
        if (localStorage.getItem('voiceMode') === 'false') {
            voiceModeToggle.checked = false;
            autoRecordEnabled = false;
        }
        
        // 监听语音模式开关变化
        voiceModeToggle.addEventListener('change', function() {
            autoRecordEnabled = this.checked;
            localStorage.setItem('voiceMode', autoRecordEnabled);
            console.log('语音模式已' + (autoRecordEnabled ? '启用' : '禁用'));
            
            // 如果禁用语音模式，确保停止当前可能进行的录音
            if (!autoRecordEnabled && isRecording) {
                stopRecording();
            }
        });
        
        // 添加可靠的滚动到底部函数
        function scrollToBottom(smooth = true) {
            const container = document.querySelector('.container');
            if (container) {
                container.scroll({
                    top: container.scrollHeight,
                    behavior: smooth ? 'smooth' : 'auto'
                });
            }
        }

        // 添加自动滚动观察器
        const autoScrollObserver = new MutationObserver(() => {
            scrollToBottom();
        });

        // 开始观察聊天消息容器的变化
        autoScrollObserver.observe(chatMessages, {
            childList: true,
            subtree: true
        });

        // 从localStorage获取患者信息
        const patientInfo = JSON.parse(localStorage.getItem('patientInfo'));
        if (!patientInfo) {
            // 如果没有患者信息，重定向到登录页面
            window.location.href = '/login';
        }

        socket.on('connect', () => {
            console.log('Connected to server');
            // 连接成功后提交患者信息
            if (patientInfo) {
                socket.emit('submit_patient_info', patientInfo);
            }
        });

        socket.on('connect_error', (error) => {
            console.log('Connection error:', error);
            // 如果连接错误可能是未认证，重定向到登录页面
            window.location.href = '/login';
        });

        // 添加未认证错误处理
        socket.on('error', (error) => {
            if (error === 'Unauthorized') {
                window.location.href = '/login';
            }
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
        });

        // 监听语音数据
        socket.on('speech', (data) => {
            console.log('收到语音数据', data ? '数据存在' : '数据不存在');
            if (data && data.audio) {
                console.log('音频数据长度:', data.audio.length);
                
                // 如果正在录音，不播放语音
                if (isRecording) {
                    console.log('正在录音，不播放语音');
                    return;
                }
                
                playAudio(data.audio);
            } else {
                console.error('未收到有效的音频数据');
            }
        });
        
        // 监听停止语音的指令
        socket.on('stop_speech', () => {
            console.log('收到停止语音指令');
            stopAudio();
        });

        socket.on('message', (data) => {
            hideTypingIndicator();
            updateAIStatus(null);
            
            if (data.type === 'status') {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'status';
                statusDiv.textContent = data.current_item;
                chatMessages.appendChild(statusDiv);
            } else if (data.type === 'assessment_complete') {
                addMessage(data.content, 'system');
                userInput.disabled = true;
                sendButton.disabled = true;
                
                window.location.href = '/phq9';
            } else if (data.type === 'message') {
                addMessage(data.content, data.role);
            }
            
            scrollToBottom();
        });

        // 播放音频
        function playAudio(base64Audio) {
            try {
                console.log('开始播放音频');
                
                // 停止当前播放的音频
                stopAudio();
                
                // 更新AI状态为说话中
                updateAIStatus('speaking');
                
                // 创建音频元素
                const audio = new Audio();
                audio.src = 'data:audio/mp3;base64,' + base64Audio;
                
                // 设置事件处理
                audio.onerror = (e) => {
                    console.error('音频播放错误:', e);
                    updateAIStatus(null);
                };
                
                audio.onloadeddata = () => {
                    console.log('音频已加载，准备播放');
                    
                    // 获取音频时长
                    if (audio.duration && audio.duration !== Infinity) {
                        console.log('音频时长:', audio.duration, '秒');
                        
                        // 如果音频时长大于3秒，提前3秒初始化麦克风
                        if (audio.duration > 3 && autoRecordEnabled) {
                            const preInitTime = (audio.duration - 3) * 1000;
                            console.log('将在', preInitTime, 'ms后提前初始化麦克风');
                            
                            setTimeout(() => {
                                console.log('提前初始化麦克风');
                                // 预先初始化麦克风，但不开始录音
                                preInitializeMicrophone();
                            }, preInitTime);
                        }
                    }
                };
                
                audio.onended = () => {
                    console.log('音频播放完成');
                    currentAudio = null;
                    
                    // 音频播放完毕后自动开始录音（如果语音模式已启用）
                    if (autoRecordEnabled) {
                        console.log('语音模式已启用，自动开始录音');
                        // 立即更新AI状态为聆听中，不等待麦克风初始化完成
                        updateAIStatus('listening');
                        
                        if (preinitializedStream) {
                            // 如果已经提前初始化了麦克风，直接使用它
                            console.log('使用预先初始化的麦克风流');
                            startRecordingWithStream(preinitializedStream);
                        } else {
                            // 否则正常初始化并开始录音
                            setTimeout(() => startRecording(), 1);
                        }
                    } else {
                        console.log('语音模式已禁用，不自动开始录音');
                        updateAIStatus(null);
                        // 将焦点放在输入框上
                        userInput.focus();
                    }
                };
                
                // 保存当前音频引用
                currentAudio = audio;
                
                // 尝试播放
                audio.play().then(() => {
                    console.log('音频开始播放');
                }).catch(err => {
                    console.error('自动播放失败:', err);
                    updateAIStatus(null);
                    
                    // 显示播放按钮
                    const playButton = document.createElement('button');
                    playButton.textContent = '点击播放语音';
                    playButton.className = 'play-button';
                    playButton.onclick = () => {
                        audio.play();
                        updateAIStatus('speaking');
                        playButton.remove();
                    };
                    
                    document.querySelector('.chat-container').appendChild(playButton);
                });
            } catch (error) {
                console.error('播放音频错误:', error);
                updateAIStatus(null);
            }
        }
        
        // 停止当前播放的音频
        function stopAudio() {
            if (currentAudio) {
                console.log('停止当前音频');
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
                updateAIStatus(null);
            }
            
            // 移除所有播放按钮
            document.querySelectorAll('.play-button').forEach(button => {
                button.remove();
            });
        }

        function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            // 停止当前播放的音频
            stopAudio();
            
            addMessage(message, 'user');
            showTypingIndicator();
            updateAIStatus('thinking');
            
            socket.emit('user_input', {
                content: message
            });
            
            userInput.value = '';
            scrollToBottom();
        }

        function addMessage(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function showTypingIndicator() {
            typingIndicator.style.display = 'block';
            scrollToBottom();
        }

        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }
        
        // 录音相关功能
        async function initializeRecording() {
            try {
                // 停止当前播放的音频，但保留AI状态
                if (currentAudio) {
                    console.log('停止当前音频但保留AI状态');
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    currentAudio = null;
                    // 不更新AI状态，保持"聆听中"
                    
                    // 移除所有播放按钮
                    document.querySelectorAll('.play-button').forEach(button => {
                        button.remove();
                    });
                }
                
                console.log('初始化麦克风');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                // 保存流引用，以便后续关闭
                mediaStream = stream;
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus',
                    audioBitsPerSecond: 16000
                });
                
                // 设置数据可用性处理
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                // 设置录音停止处理
                mediaRecorder.onstop = async () => {
                    console.log('录音已停止，处理录音数据');
                    isRecording = false;
                    
                    // 更新UI
                    const button = document.getElementById('record-button');
                    button.classList.remove('recording');
                    
                    // 如果有录音数据，则处理
                    if (audioChunks.length > 0) {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        // 转换为WAV格式
                        const wavBlob = await convertToWav(audioBlob);
                        const base64data = await blobToBase64(wavBlob);
                        
                        // 发送音频数据到服务器
                        socket.emit('audio_data', base64data);
                        
                        // 清空录音数据
                        audioChunks = [];
                    }
                    
                    // 关闭麦克风
                    releaseMediaStream();
                    
                    // 清理静音检测
                    cleanupSilenceDetection();
                };
                
                // 设置录音开始处理
                mediaRecorder.onstart = () => {
                    console.log('录音开始');
                    // 重置用户说话状态
                    userHasSpoken = false;
                    consecutiveSpeakingCount = 0;
                    
                    // 启动定时器，如果60秒内没有完成录音，强制结束录音
                    silenceTimer = setTimeout(() => {
                        console.log('录音时间过长，自动停止');
                        if (mediaRecorder && mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                        }
                    }, 60000); // 60秒最大录音时间
                };
                
                // 创建静音检测
                setupSilenceDetection(stream);
                
                return true;
            } catch (err) {
                console.error('麦克风访问错误:', err);
                alert('请允许访问麦克风');
                return false;
            }
        }
        
        // 释放麦克风资源
        function releaseMediaStream() {
            if (mediaStream) {
                console.log('释放麦克风资源');
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
                mediaRecorder = null;
            }
            
            // 释放预初始化的流资源
            if (preinitializedStream) {
                console.log('释放预初始化的麦克风资源');
                preinitializedStream.getTracks().forEach(track => track.stop());
                preinitializedStream = null;
            }
        }

        // 设置静音检测
        function setupSilenceDetection(stream) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                const scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);
                
                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;
                
                microphone.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                let silenceStart = null;
                let isSpeaking = false;
                
                // 重置状态
                userHasSpoken = false;
                consecutiveSpeakingCount = 0;
                consecutiveSilenceCount = 0;
                
                scriptProcessor.onaudioprocess = function() {
                    analyser.getByteFrequencyData(dataArray);
                    
                    // 计算音量
                    let sum = 0;
                    for(let i = 0; i < bufferLength; i++) {
                        sum += dataArray[i];
                    }
                    
                    const average = sum / bufferLength;
                    const volume = average / 255;  // 归一化为0-1
                    const dbLevel = volume ? 20 * Math.log10(volume) : -100; // 转换为分贝
                    
                    // 显示音量指示器
                    console.log(`音量: ${Math.round(dbLevel)} dB, 用户已说话: ${userHasSpoken}`);
                    
                    // 检测是否有声音
                    if (dbLevel > silenceThreshold) {
                        // 如果检测到声音
                        if (!userHasSpoken) {
                            // 如果用户尚未被标记为开始说话
                            consecutiveSpeakingCount++;
                            console.log(`连续说话计数: ${consecutiveSpeakingCount}/${requiredSpeakingCount}`);
                            
                            if (consecutiveSpeakingCount >= requiredSpeakingCount) {
                                // 当连续多次检测到声音，认为用户开始说话
                                userHasSpoken = true;
                                console.log('用户开始说话，启动静音检测');
                            }
                        } else {
                            // 用户已经在说话，重置静音计数
                            if (!isSpeaking) {
                                console.log('说话继续中...');
                                isSpeaking = true;
                            }
                            silenceStart = null; // 重置静音计时器
                            consecutiveSilenceCount = 0; // 重置连续静音计数
                        }
                    } else {
                        // 如果检测到静音
                        
                        // 只有当用户已经开始说话后，才进行静音检测来结束录音
                        if (userHasSpoken) {
                            consecutiveSilenceCount++; // 增加连续静音计数
                            console.log(`连续静音计数: ${consecutiveSilenceCount}/${requiredSilenceCount}`);
                            
                            // 只有连续多次检测到静音才开始计时
                            if (consecutiveSilenceCount >= requiredSilenceCount) {
                                if (silenceStart === null) {
                                    silenceStart = Date.now();
                                    console.log('检测到持续静音开始');
                                } else if (Date.now() - silenceStart > silenceTimeout) {
                                    console.log('检测到静音超过阈值，自动停止录音');
                                    isSpeaking = false;
                                    silenceStart = null;
                                    consecutiveSilenceCount = 0;
                                    userHasSpoken = false;
                                    
                                    // 如果静音超过阈值，自动停止录音
                                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                                        console.log('执行自动停止录音');
                                        mediaRecorder.stop();
                                    }
                                }
                            }
                        } else {
                            // 用户尚未开始说话，重置说话计数
                            consecutiveSpeakingCount = 0;
                        }
                    }
                };
                
                // 保存引用以便清理
                silenceDetector = {
                    audioContext,
                    analyser,
                    microphone,
                    scriptProcessor
                };
                
            } catch (error) {
                console.error('设置静音检测时出错:', error);
            }
        }
        
        // 清理静音检测
        function cleanupSilenceDetection() {
            if (silenceDetector) {
                try {
                    silenceDetector.scriptProcessor.disconnect();
                    silenceDetector.analyser.disconnect();
                    silenceDetector.microphone.disconnect();
                    silenceDetector.audioContext.close();
                } catch (error) {
                    console.error('清理静音检测时出错:', error);
                }
                silenceDetector = null;
            }
            
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }
        }
        
        // 开始录音
        async function startRecording() {
            if (isRecording) {
                console.log('已经在录音中，忽略开始录音请求');
                return;
            }
            
            console.log('开始录音');
            
            // 初始化录音设备
            const initialized = await initializeRecording();
            if (!initialized) {
                // 如果初始化失败，重置状态
                updateAIStatus(null);
                return;
            }
            
            // 更新UI
            const button = document.getElementById('record-button');
            button.classList.add('recording');
            
            // 开始录音
            isRecording = true;
            audioChunks = [];
            mediaRecorder.start();
        }
        
        // 停止录音
        function stopRecording() {
            if (!isRecording) {
                console.log('没有在录音，忽略停止录音请求');
                return;
            }
            
            console.log('停止录音');
            updateAIStatus('thinking');
            
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        // 重写录音按钮点击处理函数
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        // 添加音频格式转换函数
        async function convertToWav(blob) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const arrayBuffer = await blob.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            // 创建新的 AudioBuffer (16kHz, 单声道)
            const targetSampleRate = 16000;
            const offlineContext = new OfflineAudioContext(1, audioBuffer.duration * targetSampleRate, targetSampleRate);
            const source = offlineContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(offlineContext.destination);
            source.start();
            
            const renderedBuffer = await offlineContext.startRendering();
            const wavData = audioBufferToWav(renderedBuffer);
            return new Blob([wavData], { type: 'audio/wav' });
        }

        // WAV 编码函数
        function audioBufferToWav(buffer) {
            const numChannels = 1;
            const sampleRate = buffer.sampleRate;
            const format = 1; // PCM
            const bitDepth = 32;
            
            const data = buffer.getChannelData(0);
            const arrayBuffer = new ArrayBuffer(44 + data.length * 4);
            const view = new DataView(arrayBuffer);
            
            // WAV 文件头
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + data.length * 4, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 4, true);
            view.setUint16(32, numChannels * 4, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, data.length * 4, true);
            
            // 写入音频数据
            const floatArray = new Float32Array(view.buffer, 44, data.length);
            floatArray.set(data);
            
            return arrayBuffer;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        // 转换 Blob 为 Base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        // 处理服务器返回的转写结果
        socket.on('transcription', function(data) {
            if (data.text) {
                document.getElementById('user-input').value = data.text;
                
                // 自动发送消息
                sendMessage();
            }
        });

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 防止iOS设备上的输入框弹出时页面上移
        document.body.addEventListener('focus', (e) => {
            if (e.target.tagName === 'INPUT') {
                document.body.scrollTop = 0;
            }
        }, true);

        // 高亮当前页面的导航按钮
        document.querySelectorAll('.nav-links a').forEach(link => {
            if (link.getAttribute('href') === window.location.pathname) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
        
        // 页面关闭时释放资源
        window.addEventListener('beforeunload', () => {
            stopAudio();
            releaseMediaStream();
            
            // 如果有预初始化的流，也要释放
            if (preinitializedStream) {
                preinitializedStream.getTracks().forEach(track => track.stop());
                preinitializedStream = null;
            }
        });

        // 预先初始化麦克风但不开始录音
        async function preInitializeMicrophone() {
            try {
                // 如果已经有预初始化的流，先释放
                if (preinitializedStream) {
                    preinitializedStream.getTracks().forEach(track => track.stop());
                    preinitializedStream = null;
                }
                
                console.log('预初始化麦克风开始');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                // 保存预初始化的流
                preinitializedStream = stream;
                console.log('麦克风预初始化完成，流已保存');
                
                return true;
            } catch (err) {
                console.error('麦克风预初始化错误:', err);
                preinitializedStream = null;
                return false;
            }
        }
        
        // 使用已初始化的流开始录音
        function startRecordingWithStream(stream) {
            if (isRecording) {
                console.log('已经在录音中，忽略开始录音请求');
                return;
            }
            
            try {
                console.log('使用预初始化的流开始录音');
                
                // 保存流引用，以便后续关闭
                mediaStream = stream;
                preinitializedStream = null;  // 清空预初始化流引用
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus',
                    audioBitsPerSecond: 16000
                });
                
                // 设置数据可用性处理
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                // 设置录音停止处理
                mediaRecorder.onstop = async () => {
                    console.log('录音已停止，处理录音数据');
                    isRecording = false;
                    
                    // 更新UI
                    const button = document.getElementById('record-button');
                    button.classList.remove('recording');
                    
                    // 如果有录音数据，则处理
                    if (audioChunks.length > 0) {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        // 转换为WAV格式
                        const wavBlob = await convertToWav(audioBlob);
                        const base64data = await blobToBase64(wavBlob);
                        
                        // 发送音频数据到服务器
                        socket.emit('audio_data', base64data);
                        
                        // 清空录音数据
                        audioChunks = [];
                    }
                    
                    // 关闭麦克风
                    releaseMediaStream();
                    
                    // 清理静音检测
                    cleanupSilenceDetection();
                };
                
                // 设置录音开始处理
                mediaRecorder.onstart = () => {
                    console.log('录音开始');
                    // 重置用户说话状态
                    userHasSpoken = false;
                    consecutiveSpeakingCount = 0;
                    
                    // 启动定时器，如果60秒内没有完成录音，强制结束录音
                    silenceTimer = setTimeout(() => {
                        console.log('录音时间过长，自动停止');
                        if (mediaRecorder && mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                        }
                    }, 60000); // 60秒最大录音时间
                };
                
                // 创建静音检测
                setupSilenceDetection(stream);
                
                // 更新UI
                const button = document.getElementById('record-button');
                button.classList.add('recording');
                
                // 开始录音
                isRecording = true;
                audioChunks = [];
                mediaRecorder.start();
                
                return true;
            } catch (err) {
                console.error('使用预初始化流开始录音错误:', err);
                
                // 如果失败，释放资源
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                return false;
            }
        }
    </script>
</body>
</html> 