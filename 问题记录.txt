如果在语音朗读完成前发送回复，似乎信息发送没有成功，是不是进程被掩盖了？
现在虽然不会掩盖进程了，但是系统还是会等到语音朗读完成后再发送回复，这样用户体验就不好了。
进度恢复后，前端输出的还是提取的问题，能否修改为显示为之前的对话历史
语音输出的功能似乎失效了，检查一下代码

#以下为待完成
修改语音输出的代码，现在系统还是等待语音播放完毕才响应。调整为按下发送按钮后，语音播放会立即停止并发送消息以推进问诊
条目19播放了语音，但是文本没有显示，检查一下代码
最后结束的逻辑也需要修改，如果条目19也输出了json，即所有条目评估完成，弹出窗口提示评估完成

为了方便表述，我们将整个框架进行理解的，就前端的输出模式而将其定义为问诊agent，现在是不是问诊agent会总体上有可能输出到前端的是两种内容：
1.是getquestion函数获得的切分出的问题；2.是LLM根据输入内容输出的结果，不过2中又会根据逻辑判定，有一部分被输出到前端，有一些则不会。
后续我希望通过自动化程序对框架的性能进行评估，因此我希望将其封装为agent的格式方便调用。


然后我们需要设置一个病人agent，他要完成的事情就很简单了，接收来自问诊agent的

有个问题需要解决，比如#label#5
{
   "任务说明": "请根据以下步骤完成问诊和评分评估，目标是明确患者对于该问题的评分，并在明确评分后进行格式化输出。",
   "语气": "简洁，口语化",
   "步骤": {
      "1.判断": "根据当前对话历史判断评分。",
      "2.澄清": "如果患者的回答不足以明确评分，请用进一步的问题澄清。",
      "3.JSON输出": "仅在问诊完成、评分明确后，请输出以下格式的JSON：{"label": 4,"score": x}{"label": 5,"score": y}{"label": 6,"score": z}(其中，x,y,z分别为入睡困难、睡眠不深、早醒的评分。)"
   },
   "条目详情": {
      "问题": "最近您的睡眠怎么样，有没有入睡困难、睡眠浅或者常常早醒的情况？",
      "入睡困难（4）": {
         "0分": "没有入睡困难。",
         "1分": "主诉存在入睡困难，通常需要超过30分钟才能入睡。",
         "2分": "每天都有明显的入睡困难，均需要30分钟才能入睡。",
      },
      "睡眠不深（5）": {
         "0分": "睡眠质量良好。",
         "1分": "睡眠较浅，做梦较多。",
         "2分": "睡到一半会醒来（不包括上厕所）",
      },
      "早醒（6）": {
         "0分": "没有早醒，能够正常睡到早晨。",
         "1分": "比正常的睡眠习惯早醒1小时，但能够重新入睡。",
         "2分": "早醒后无法重新入睡。",
      }
   },
   "重要提示": "请在你认为能够判断出评分时才输出json格式，也请不要与患者讨论分数等内容。"
}像该条目最后系统输出的是三个json文件，我之前在framework也设置了如果多个json的话分别解析，但是现在好像没有生效，请帮我检查一下。然后如果目前的格式解析有困难的话，是不是输出格式改为{"4":  x}{"5":  y}{"6": z}会更好？

我尝试对newprompt做了一些调整，让我重新描述一下我的项目结构，你可以检查一下流程是否被正确的执行了
运行testagents的py文件后，首先会切分我的newprompt文件，切分为19段提示词，作为19个问诊条目的系统提示词
diagnosisagent作为一个传递assesmentframework的中介，完成其工作。

我简单介绍一下framework的功能：
目前较为完善的部分：发出开头问题，在提示词的指引下输出追问或评分，切换到下一条目。
需要调整的部分：修改提示词后，现在LLM在输出评分结果是，比如多条目会用{"hamd12": x,"hamd16": y}的格式，单条目也就是简单的{"hamd22": x}格式，储存结果的格式应该是hamd1-24这样平行的格式，以便我后续导入到csv中进行数据分析
对于这一调整，请对assesmentframework和patientagent都作修改，以保障前端页面和testagent都能正常运转

而patientagent的主要功能是接受diagnosisagent的信息，然后做出回应。然后历史对话被apend以实现多轮问答。目前有两种模式可选，一种是历史对话为总流程的历史对话，即跨条目。另一种模式为了节省token而设计，patientagent接受到的messages限于当前条目，即从当前条目的开头问题开始的。

最后另一个目前需要完善的功能是关于原始LLM输出的储存：
1.目前framework下，LLM输出内容包括json时不会被发送出去，而是进入分数解析环节，但我也希望其原始输出被储存在结果中
2.conversation_history的存储模式也要修改一下，举个例子应该像这样
条目1：
diagnosisagent：问题
patientagent：回应
diagnosisagent：追问
patientagent：回应
diagnosisagent：包含json的原始输出结果
条目2：
diagnosisagent：问题
patientagent：回应…………


准备调整条目顺序

条目顺序的梳理：
hamd1目前的评定仍然存在问题。8.9.11需要观察来评定，分别是阻滞、激越和焦虑躯体症状；
